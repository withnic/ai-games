<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãƒã‚¤ï¼†ãƒ­ãƒ¼ ã‚²ãƒ¼ãƒ  (ã‚¢ã‚¤ãƒ†ãƒ æ©Ÿèƒ½ä»˜)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Noto Sans JP', sans-serif;
            touch-action: manipulation;
        }
        .card {
            width: 120px;
            height: 180px;
            perspective: 1000px;
        }
        .card-inner {
            position: relative;
            width: 100%;
            height: 100%;
            transition: transform 0.6s;
            transform-style: preserve-3d;
        }
        .card.flipped .card-inner {
            transform: rotateY(180deg);
        }
        .card-face {
            position: absolute;
            width: 100%;
            height: 100%;
            -webkit-backface-visibility: hidden;
            backface-visibility: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
            border-radius: 0.75rem;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            border: 1px solid rgba(0,0,0,0.1);
        }
        .card-front { 
            background-color: #4f46e5;
            background-image: radial-gradient(circle at 1px 1px, rgba(255,255,255,0.2) 1px, transparent 0);
            background-size: 20px 20px;
            color: white;
        }
        .card-back { 
            background-color: #f8fafc;
            color: #1e293b;
            font-size: 3.5rem;
            font-weight: bold;
            transform: rotateY(180deg);
        }
        .btn {
            transition: all 0.2s ease-in-out;
        }
        .btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.15);
        }
        .btn:active:not(:disabled) {
            transform: translateY(0);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        @keyframes pulse-light {
            0%, 100% { box-shadow: 0 0 5px #fde047, 0 0 10px #fde047; }
            50% { box-shadow: 0 0 15px #facc15, 0 0 25px #facc15; }
        }
        .pulsing {
            animation: pulse-light 1.5s infinite;
        }
    </style>
</head>
<body class="bg-slate-100 flex items-center justify-center min-h-screen p-4">

    <div class="w-full max-w-md mx-auto bg-white rounded-2xl shadow-xl p-6 text-center">

        <h1 class="text-3xl md:text-4xl font-bold text-slate-800 mb-2">ãƒã‚¤ï¼†ãƒ­ãƒ¼</h1>
        <p class="text-slate-500 mb-4">å¥ªé‚„ãƒœãƒ¼ãƒŠã‚¹ã§ä¸€æ”«åƒé‡‘ï¼</p>

        <!-- NEW: Today's Records Area -->
        <div class="mb-4 text-center">
            <div class="inline-block bg-amber-100 text-amber-800 rounded-lg px-4 py-2">
                <p class="text-sm font-semibold">ğŸŒŸ æœ¬æ—¥ã®æœ€é«˜ãƒ¡ãƒ€ãƒ«: <span id="todays-max-medals" class="font-bold">100</span></p>
                <p class="text-sm font-semibold">ğŸ‰ æœ¬æ—¥ã®æœ€å¤§ç²å¾—: <span id="todays-max-winnings" class="font-bold">0</span></p>
            </div>
        </div>

        <!-- ãƒ¡ãƒ€ãƒ«ã¨ã‚¹ã‚³ã‚¢è¡¨ç¤º -->
        <div class="space-y-2 bg-slate-50 p-3 rounded-lg mb-4 text-center">
            <div class="grid grid-cols-2 gap-2">
                <div>
                    <p class="text-slate-500 text-xs">ğŸ’° æ‰€æŒãƒ¡ãƒ€ãƒ«</p>
                    <p id="medals" class="text-xl font-bold text-indigo-600">100</p>
                </div>
                <div id="pool-container">
                    <p class="text-slate-500 text-xs">ğŸ”¥ ãƒ—ãƒ¼ãƒ«è³é‡‘</p>
                    <p id="pool" class="text-xl font-bold text-amber-500">0</p>
                </div>
            </div>
            <div class="grid grid-cols-2 gap-2 border-t border-slate-200 pt-2">
                <div>
                    <p class="text-slate-500 text-xs">ğŸ† æœ¬æ—¥ã®æ­£è§£æ•°</p>
                    <p id="todays-wins" class="text-lg font-bold text-slate-800">0</p>
                </div>
                <div>
                    <p class="text-slate-500 text-xs">ğŸ’€ æ²¡åãƒ¡ãƒ€ãƒ«</p>
                    <p id="forfeited-medals" class="text-lg font-bold text-red-600">0</p>
                </div>
            </div>
        </div>

        <!-- ã‚«ãƒ¼ãƒ‰è¡¨ç¤ºã‚¨ãƒªã‚¢ -->
        <div class="flex justify-around items-center mb-4">
            <div>
                <p class="text-sm font-bold text-slate-500 mb-2">ç¾åœ¨ã®ã‚«ãƒ¼ãƒ‰</p>
                <div id="current-card-container" class="card">
                    <div class="card-inner">
                        <div class="card-face card-front"></div>
                        <div id="current-card" class="card-face card-back"></div>
                    </div>
                </div>
            </div>
            <div>
                <p class="text-sm font-bold text-slate-500 mb-2">æ¬¡ã®ã‚«ãƒ¼ãƒ‰</p>
                <div id="next-card-container" class="card">
                    <div class="card-inner">
                        <div class="card-face card-front"></div>
                        <div id="next-card" class="card-face card-back"></div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- ã‚¢ã‚¤ãƒ†ãƒ ã‚·ãƒ§ãƒƒãƒ—ã¨æ‰€æŒã‚¢ã‚¤ãƒ†ãƒ  -->
        <div id="item-section" class="my-4 p-3 bg-slate-50 rounded-lg">
            <div class="flex justify-between items-center mb-2 gap-2">
                <h3 class="font-bold text-slate-700">ã‚¢ã‚¤ãƒ†ãƒ </h3>
                <div class="flex gap-2">
                    <button id="buy-shuffle-btn" class="btn bg-cyan-400 hover:bg-cyan-500 text-white font-bold py-1 px-3 rounded-md text-sm">ğŸ”„ (10ğŸ’°)</button>
                    <button id="buy-knife-btn" class="btn bg-rose-500 hover:bg-rose-600 text-white font-bold py-1 px-3 rounded-md text-sm">ğŸ”ª (30ğŸ’°)</button>
                </div>
            </div>
            <div id="inventory-area" class="flex gap-2 justify-center items-center min-h-[40px]">
                <!-- æ‰€æŒã‚¢ã‚¤ãƒ†ãƒ ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã‚‹ -->
            </div>
            <p id="item-warning-message" class="text-xs text-red-500 mt-1 h-4"></p>
        </div>

        <!-- ãƒ™ãƒƒãƒˆå…¥åŠ›ã‚¨ãƒªã‚¢ -->
        <div id="bet-area" class="mb-4">
            <label class="block text-sm font-medium text-slate-700 mb-2">ãƒ™ãƒƒãƒˆã™ã‚‹æšæ•°</label>
            <div class="flex justify-center items-center space-x-4">
                <button id="decrease-bet-btn" class="btn bg-slate-200 hover:bg-slate-300 text-slate-800 font-bold w-12 h-12 rounded-full text-2xl flex items-center justify-center">-</button>
                <p id="bet-display" class="text-2xl font-bold w-16 text-center">1</p>
                <button id="increase-bet-btn" class="btn bg-slate-200 hover:bg-slate-300 text-slate-800 font-bold w-12 h-12 rounded-full text-2xl flex items-center justify-center">+</button>
            </div>
        </div>

        <!-- çµæœãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤ºã‚¨ãƒªã‚¢ -->
        <div id="message" class="h-12 flex items-center justify-center mb-4">
             <p class="text-xl font-bold"></p>
        </div>

        <!-- æ“ä½œãƒœã‚¿ãƒ³ã‚¨ãƒªã‚¢ -->
        <div id="action-area" class="mb-6">
            <button id="action-btn" class="w-full btn bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-5 rounded-lg">å‹è² ï¼</button>
        </div>
        <div id="controls" class="grid grid-cols-2 gap-4 mb-6" style="display: none;">
            <button id="low-btn" class="btn bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-4 rounded-lg text-lg shadow-md">LOW</button>
            <button id="high-btn" class="btn bg-red-500 hover:bg-red-600 text-white font-bold py-3 px-4 rounded-lg text-lg shadow-md">HIGH</button>
        </div>
        <button id="cashout-btn" class="w-full btn bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-5 rounded-lg mb-6" style="display: none;">æ›é‡‘ã™ã‚‹</button>

        <button id="reset-btn" class="w-full btn bg-slate-600 hover:bg-slate-700 text-white font-bold py-2 px-5 rounded-lg text-sm">ã‚²ãƒ¼ãƒ ã‚’ãƒªã‚»ãƒƒãƒˆ</button>
    </div>

    <script>
        // --- DOMè¦ç´ ã®å–å¾— ---
        const currentCardContainerEl = document.getElementById('current-card-container');
        const currentCardEl = document.getElementById('current-card');
        const nextCardEl = document.getElementById('next-card');
        const nextCardContainerEl = document.getElementById('next-card-container');
        const highBtn = document.getElementById('high-btn');
        const lowBtn = document.getElementById('low-btn');
        const resetBtn = document.getElementById('reset-btn');
        const cashoutBtn = document.getElementById('cashout-btn');
        const messageEl = document.querySelector('#message p');
        const medalsEl = document.getElementById('medals');
        const poolEl = document.getElementById('pool');
        const poolContainer = document.getElementById('pool-container');
        const betArea = document.getElementById('bet-area');
        const decreaseBetBtn = document.getElementById('decrease-bet-btn');
        const increaseBetBtn = document.getElementById('increase-bet-btn');
        const betDisplay = document.getElementById('bet-display');
        const todaysWinsEl = document.getElementById('todays-wins');
        const todaysMaxMedalsEl = document.getElementById('todays-max-medals');
        const todaysMaxWinningsEl = document.getElementById('todays-max-winnings');
        const forfeitedMedalsEl = document.getElementById('forfeited-medals');
        const controls = document.getElementById('controls');
        const actionArea = document.getElementById('action-area');
        const actionBtn = document.getElementById('action-btn');
        const buyShuffleBtn = document.getElementById('buy-shuffle-btn');
        const buyKnifeBtn = document.getElementById('buy-knife-btn');
        const inventoryArea = document.getElementById('inventory-area');
        const itemWarningMessageEl = document.getElementById('item-warning-message');

        // --- ã‚²ãƒ¼ãƒ ã®çŠ¶æ…‹ã‚’ç®¡ç†ã™ã‚‹å¤‰æ•° ---
        let currentCardValue = 0;
        let nextCardValue = 0;
        let medals = 100;
        let todaysMaxMedals = 100;
        let todaysMaxWinnings = 0;
        let pooledMedals = 0;
        let currentBet = 0;
        let lastBetAmount = 1;
        let isInDoubleUp = false;
        let todaysWins = 0;
        let forfeitedMedals = 0;
        let bonusPoints = 0;
        let isBonusGame = false;
        let bonusGameStreak = 0;
        let isKnifeBonusGame = false;
        let knifeBonusStreak = 0;
        let inventory = [];
        const STORAGE_KEY = 'highLowGameData';
        const FATAL_CARD = 'ğŸ’€';

        // --- ã‚µã‚¦ãƒ³ãƒ‰ã®æº–å‚™ (Tone.js) ---
        let synth;
        document.body.addEventListener('click', () => { if (!synth) synth = new Tone.PolySynth(Tone.Synth).toDestination(); }, { once: true });
        
        const playWinSound = () => synth?.triggerAttackRelease(["C5", "E5", "G5"], "8n");
        const playLoseSound = () => synth?.triggerAttackRelease("C3", "4n");
        const playFatalSound = () => synth?.triggerAttackRelease(["C3", "D#3", "G#3"], "2n");
        const playCashOutSound = () => synth?.triggerAttackRelease(["C4", "E4", "G4", "C5"], "8n");
        const playBetSound = () => synth?.triggerAttackRelease("D6", "16n");
        const playBonusStartSound = () => synth?.triggerAttackRelease(["C4", "G4", "C5", "E5"], "4n");
        const playCardFlipSound = () => synth?.triggerAttackRelease("A5", "16n");
        const playItemSound = () => synth?.triggerAttackRelease("A4", "8n");
        const playKnifeBonusSound = () => synth?.triggerAttackRelease(["A4", "E5", "A5"], "4n");

        // --- ãƒ‡ãƒ¼ã‚¿ç®¡ç† (localStorage) ---
        function saveGameState() {
            const gameState = { todaysWins, bonusPoints, forfeitedMedals, medals, inventory, lastBetAmount, todaysMaxMedals, todaysMaxWinnings, lastPlayed: new Date().toLocaleDateString() };
            localStorage.setItem(STORAGE_KEY, JSON.stringify(gameState));
        }

        function loadGameState() {
            const savedData = JSON.parse(localStorage.getItem(STORAGE_KEY));
            const today = new Date().toLocaleDateString();

            if (savedData) {
                medals = savedData.medals !== undefined ? savedData.medals : 100;
                inventory = savedData.inventory || [];
                forfeitedMedals = savedData.forfeitedMedals || 0;
                lastBetAmount = savedData.lastBetAmount || 1;
                if (savedData.lastPlayed === today) {
                    todaysWins = savedData.todaysWins || 0;
                    bonusPoints = savedData.bonusPoints || 0;
                    todaysMaxMedals = savedData.todaysMaxMedals || medals;
                    todaysMaxWinnings = savedData.todaysMaxWinnings || 0;
                } else {
                    todaysWins = 0;
                    bonusPoints = 0;
                    todaysMaxMedals = medals;
                    todaysMaxWinnings = 0;
                }
            }
            saveGameState();
        }

        // --- UIæ›´æ–°é–¢æ•° ---
        function updateUI() {
            if (medals > todaysMaxMedals) {
                todaysMaxMedals = medals;
            }
            medalsEl.textContent = medals;
            poolEl.textContent = pooledMedals;
            betDisplay.textContent = currentBet;
            todaysWinsEl.textContent = todaysWins;
            todaysMaxMedalsEl.textContent = todaysMaxMedals;
            todaysMaxWinningsEl.textContent = todaysMaxWinnings;
            forfeitedMedalsEl.textContent = forfeitedMedals;
            renderInventory();
            updateBetButtons();
            
            const canUseItem = controls.style.display === 'grid';
            if (inventory.includes('shuffle') && canUseItem && pooledMedals > 0) {
                itemWarningMessageEl.textContent = 'â€»ã‚·ãƒ£ãƒƒãƒ•ãƒ«ã‚’ä½¿ã†ã¨è³é‡‘ãŒåŠåˆ†ã«ãªã‚Šã¾ã™ï¼';
            } else {
                itemWarningMessageEl.textContent = '';
            }
        }
        
        function renderInventory() {
            inventoryArea.innerHTML = '';
            if (inventory.length === 0) {
                inventoryArea.innerHTML = `<p class="text-sm text-slate-400">ã‚¢ã‚¤ãƒ†ãƒ ã‚’æŒã£ã¦ã„ã¾ã›ã‚“</p>`;
            } else {
                inventory.forEach((item) => {
                    const itemBtn = document.createElement('button');
                    if (item === 'shuffle') {
                        itemBtn.innerHTML = `ğŸ”„<span class="ml-1">ã‚·ãƒ£ãƒƒãƒ•ãƒ«</span>`;
                        itemBtn.className = 'btn bg-cyan-400 hover:bg-cyan-500 text-white font-bold py-1 px-3 rounded-md text-sm';
                        itemBtn.onclick = useShuffleCard;
                    } else if (item === 'knife') {
                        itemBtn.innerHTML = `ğŸ”ª<span class="ml-1">ãƒŠã‚¤ãƒ•</span>`;
                        itemBtn.className = 'btn bg-rose-500 hover:bg-rose-600 text-white font-bold py-1 px-3 rounded-md text-sm';
                        itemBtn.onclick = useKnife;
                    }
                    inventoryArea.appendChild(itemBtn);
                });
            }
            const useButtons = inventoryArea.querySelectorAll('button');
            const canUseItem = controls.style.display === 'grid';
            useButtons.forEach(btn => btn.disabled = !canUseItem);
        }

        function updateBetButtons() {
            decreaseBetBtn.disabled = currentBet <= 1;
            increaseBetBtn.disabled = currentBet >= 10 || medals + currentBet < currentBet + 1;
        }

        // --- ã‚²ãƒ¼ãƒ é–‹å§‹/ãƒªã‚»ãƒƒãƒˆå‡¦ç† ---
        function startGame() {
            medals = 100;
            todaysMaxMedals = 100;
            todaysMaxWinnings = 0;
            pooledMedals = 0;
            currentBet = 0;
            todaysWins = 0;
            bonusPoints = 0;
            forfeitedMedals = 0;
            inventory = [];
            lastBetAmount = 1;
            saveGameState();
            isBonusGame = false;
            bonusGameStreak = 0;
            isKnifeBonusGame = false;
            knifeBonusStreak = 0;
            startNewRound();
        }

        // --- æ–°è¦ãƒ©ã‚¦ãƒ³ãƒ‰é–‹å§‹å‡¦ç† ---
        function startNewRound() {
            isInDoubleUp = false;
            isKnifeBonusGame = false;
            knifeBonusStreak = 0;
            medals += currentBet;
            currentBet = 0;
            
            if (medals > 0) {
                let potentialBet = lastBetAmount;
                if (potentialBet > medals) {
                    potentialBet = medals;
                }
                if (potentialBet === 0) {
                    potentialBet = 1;
                }
                currentBet = potentialBet;
                medals -= currentBet;
            } else {
                messageEl.textContent = "ãƒ¡ãƒ€ãƒ«ãŒãªããªã‚Šã¾ã—ãŸï¼";
                actionBtn.disabled = true;
            }
            
            currentCardContainerEl.classList.remove('flipped');
            nextCardContainerEl.classList.remove('flipped');
            setTimeout(() => {
                currentCardEl.textContent = '';
                nextCardEl.textContent = '';
            }, 300);

            poolContainer.classList.remove('pulsing');
            
            betArea.style.display = 'block';
            actionArea.style.display = 'block';
            
            if (bonusPoints > 0 && forfeitedMedals > 0) {
                 actionBtn.textContent = 'ãƒœãƒ¼ãƒŠã‚¹é–‹å§‹ï¼';
                 messageEl.innerHTML = `<span class="text-violet-500 font-bold">å¥ªé‚„ãƒœãƒ¼ãƒŠã‚¹ï¼5é€£å‹ã§æ²¡åãƒ¡ãƒ€ãƒ«ã‚’å–ã‚Šè¿”ã›ï¼</span>`;
            } else {
                actionBtn.textContent = 'å‹è² ï¼';
                messageEl.textContent = "ãƒ™ãƒƒãƒˆã—ã¦å‹è² ï¼";
            }
            
            actionBtn.disabled = medals + currentBet <= 0;
            controls.style.display = 'none';
            cashoutBtn.style.display = 'none';
            
            updateUI();
        }
        
        // --- ã‚«ãƒ¼ãƒ‰ã‚’å…¬é–‹ã—ã¦GUESSã‚’é–‹å§‹ã™ã‚‹ ---
        function prepareForGuess() {
            actionArea.style.display = 'none';
            betArea.style.display = 'none';
            controls.style.display = 'grid';
            highBtn.disabled = false;
            lowBtn.disabled = false;
            
            updateUI();
        }

        // --- äºˆæƒ³ã‚’ãƒã‚§ãƒƒã‚¯ã™ã‚‹é–¢æ•° ---
        function checkGuess(guess) {
            highBtn.disabled = true;
            lowBtn.disabled = true;
            cashoutBtn.style.display = 'none';
            inventoryArea.querySelectorAll('button').forEach(btn => btn.disabled = true);

            const betAmount = currentBet;
            if (!isInDoubleUp) {
                lastBetAmount = betAmount;
            }
            
            if (isKnifeBonusGame) {
                checkKnifeBonusGuess(guess);
                return;
            }

            nextCardValue = generateNextCardValue();
            nextCardEl.textContent = nextCardValue;
            playCardFlipSound();
            nextCardContainerEl.classList.add('flipped');
            
            setTimeout(() => {
                if (nextCardValue === FATAL_CARD) {
                    playFatalSound();
                    messageEl.innerHTML = `<span class="text-black font-bold">ãƒ‰ã‚¯ãƒ­ã ï¼å¼·åˆ¶çš„ã«è² ã‘...</span>`;
                    handleLoss(betAmount);
                    return;
                }

                const result = (nextCardValue > currentCardValue) ? 'high' : (nextCardValue < currentCardValue) ? 'low' : 'draw';

                if (guess === result || result === 'draw') {
                    handleWin(betAmount);
                } else {
                    playLoseSound();
                    messageEl.textContent = `æ®‹å¿µï¼è³é‡‘ã¯æ²¡åã§ã™...`;
                    handleLoss(betAmount);
                }
            }, 800);
        }

        function handleWin(betAmount) {
            playWinSound();
            poolContainer.classList.add('pulsing');

            if (!isBonusGame) {
                todaysWins++;
                if (todaysWins > 0 && todaysWins % 10 === 0) {
                    bonusPoints++;
                }
            }

            if (!isInDoubleUp) {
                isInDoubleUp = true;
                if (!isBonusGame) { // Normal game
                    pooledMedals = betAmount;
                    currentBet = 0;
                    pooledMedals *= 2;
                } else { // First win in Recapture Bonus
                    pooledMedals = 0; 
                    currentBet = 0;
                }
            } else {
                pooledMedals *= 2;
            }
            
            if (isBonusGame) {
                bonusGameStreak++;
                if (bonusGameStreak < 5) {
                    messageEl.innerHTML = `<span class="text-violet-500 font-bold">ãƒœãƒ¼ãƒŠã‚¹ä¸­ï¼ã‚ã¨ ${5 - bonusGameStreak}å›ï¼</span>`;
                } else {
                    const reclaimed = forfeitedMedals;
                    pooledMedals += reclaimed;
                    forfeitedMedals = 0;
                    isBonusGame = false;
                    bonusGameStreak = 0;
                    messageEl.innerHTML = `<span class="text-amber-500 font-bold">${reclaimed}æšå¥ªé‚„æˆåŠŸï¼</span>`;
                }
            } else {
                messageEl.textContent = `æ­£è§£ï¼è³é‡‘ã¯${pooledMedals}æšï¼`;
            }
            
            setTimeout(() => {
                controls.style.display = 'none';
                actionArea.style.display = 'block';
                
                if (isBonusGame || isKnifeBonusGame) {
                    actionBtn.textContent = 'ç¶šã‘ã‚‹';
                    actionBtn.disabled = false;
                } else {
                    const continueCost = Math.ceil(pooledMedals / 3);
                    actionBtn.textContent = `ç¶šã‘ã‚‹ (ã‚³ã‚¹ãƒˆ: ${continueCost}ğŸ’°)`;
                    if (medals < continueCost) {
                        actionBtn.disabled = true;
                    } else {
                        actionBtn.disabled = false;
                    }
                }
                
                if (!isBonusGame && !isKnifeBonusGame) {
                    cashoutBtn.style.display = 'block';
                }
            }, 1000);
            updateUI();
            saveGameState();
        }

        function handleLoss(betAmount) {
            const lostAmount = (pooledMedals > 0 ? pooledMedals : betAmount);
            forfeitedMedals += lostAmount;
            
            pooledMedals = 0;
            currentBet = 0;
            isBonusGame = false;
            bonusGameStreak = 0;
            
            if (medals <= 0 && currentBet <= 0) {
                messageEl.textContent = "ãƒ¡ãƒ€ãƒ«ãŒãªããªã‚Šã¾ã—ãŸ...ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã€‚";
                setTimeout(startGame, 2500);
            } else {
                 setTimeout(startNewRound, 2500);
            }
            updateUI();
            saveGameState();
        }

        // --- ã‚¢ã‚¤ãƒ†ãƒ é–¢é€£ã®é–¢æ•° ---
        function buyItem(itemName, cost) {
            if (medals < cost) {
                messageEl.textContent = 'ãƒ¡ãƒ€ãƒ«ãŒè¶³ã‚Šã¾ã›ã‚“ï¼';
                return;
            }
            if (inventory.length >= 3) {
                messageEl.textContent = 'ã‚¢ã‚¤ãƒ†ãƒ ãŒã„ã£ã±ã„ã§ã™ï¼';
                return;
            }
            medals -= cost;
            inventory.push(itemName);
            playItemSound();
            updateUI();
            saveGameState();
        }

        function useShuffleCard() {
            const itemIndex = inventory.indexOf('shuffle');
            if (itemIndex > -1) {
                inventory.splice(itemIndex, 1);
                
                if (isInDoubleUp && pooledMedals > 0) {
                    pooledMedals = Math.floor(pooledMedals / 2);
                }
                
                currentCardValue = generateCurrentCardValue();
                currentCardEl.textContent = currentCardValue;
                playItemSound();
                updateUI();
                saveGameState();
            }
        }

        function useKnife() {
            const itemIndex = inventory.indexOf('knife');
            if (itemIndex > -1) {
                inventory.splice(itemIndex, 1);
                playItemSound();
                inventoryArea.querySelectorAll('button').forEach(btn => btn.disabled = true);
                
                nextCardValue = generateNextCardValue();
                nextCardEl.textContent = nextCardValue;
                nextCardContainerEl.classList.add('flipped');

                setTimeout(() => {
                    if (nextCardValue === FATAL_CARD) {
                        playKnifeBonusSound();
                        isKnifeBonusGame = true;
                        knifeBonusStreak = 0;
                        pooledMedals += (medals + forfeitedMedals) * 2;
                        medals = 0;
                        forfeitedMedals = 0;
                        messageEl.innerHTML = `<span class="text-rose-500 font-bold">ãƒŠã‚¤ãƒ•ãƒœãƒ¼ãƒŠã‚¹ï¼10é€£å‹ã§ç·å–ã‚Šï¼</span>`;
                        currentCardValue = generateCurrentCardValue();
                        currentCardEl.textContent = currentCardValue;
                        nextCardContainerEl.classList.remove('flipped');
                        setTimeout(() => nextCardEl.textContent = '', 300);
                        highBtn.disabled = false;
                        lowBtn.disabled = false;
                    } else {
                        messageEl.textContent = 'ãƒŠã‚¤ãƒ•ã¯ç©ºã‚’åˆ‡ã£ãŸ...å¤±æ•—ã ã€‚';
                        handleLoss(currentBet);
                    }
                    updateUI();
                    saveGameState();
                }, 1000);
            }
        }
        
        function checkKnifeBonusGuess(guess) {
             nextCardValue = generateNextCardValue();
             nextCardEl.textContent = nextCardValue;
             playCardFlipSound();
             nextCardContainerEl.classList.add('flipped');

             setTimeout(() => {
                if (nextCardValue === FATAL_CARD) {
                    playFatalSound();
                    messageEl.innerHTML = `<span class="text-black font-bold">ãƒœãƒ¼ãƒŠã‚¹å¤±æ•—ï¼</span>`;
                    handleLoss(0);
                    return;
                }
                const result = (nextCardValue > currentCardValue) ? 'high' : (nextCardValue < currentCardValue) ? 'low' : 'draw';
                if (guess === result || result === 'draw') {
                    playWinSound();
                    knifeBonusStreak++;
                    pooledMedals *= 2;
                    if (knifeBonusStreak >= 10) {
                        messageEl.innerHTML = `<span class="text-amber-500 font-bold">10é€£å‹é”æˆï¼ãŠã‚ã§ã¨ã†ï¼</span>`;
                        cashOut();
                    } else {
                        messageEl.innerHTML = `<span class="text-rose-500 font-bold">ã‚ã¨ ${10 - knifeBonusStreak} å›ï¼</span>`;
                        currentCardValue = nextCardValue;
                        setTimeout(() => {
                            nextCardContainerEl.classList.remove('flipped');
                            highBtn.disabled = false;
                            lowBtn.disabled = false;
                        }, 1000);
                    }
                } else {
                    playLoseSound();
                    messageEl.innerHTML = `<span class="text-black font-bold">ãƒœãƒ¼ãƒŠã‚¹å¤±æ•—ï¼</span>`;
                    handleLoss(0);
                }
                updateUI();
             }, 800);
        }

        // --- æ›é‡‘å‡¦ç† ---
        function cashOut() {
            playCashOutSound();
            messageEl.textContent = `${pooledMedals}æšç²å¾—ï¼ãŠã‚ã§ã¨ã†ï¼`;
            
            if (pooledMedals > todaysMaxWinnings) {
                todaysMaxWinnings = pooledMedals;
            }

            medals += pooledMedals;
            pooledMedals = 0;
            
            setTimeout(startNewRound, 2000);
        }

        const generateCurrentCardValue = () => Math.floor(Math.random() * 13) + 1;
        const generateNextCardValue = () => {
            const rand = Math.floor(Math.random() * 20);
            if (rand >= 19) {
                return FATAL_CARD;
            }
            return Math.floor(Math.random() * 13) + 1;
        };

        // --- ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ ---
        actionBtn.addEventListener('click', () => {
            cashoutBtn.style.display = 'none';
            if (actionBtn.textContent.startsWith('ç¶šã‘ã‚‹')) {
                if (!isBonusGame) { // FIX: Only charge cost if not in RECAPTURE bonus
                    const continueCost = Math.ceil(pooledMedals / 3);
                    if (medals < continueCost) {
                        messageEl.textContent = `ç¶šã‘ã‚‹ã«ã¯${continueCost}æšã®ãƒ¡ãƒ€ãƒ«ãŒå¿…è¦ã§ã™ï¼`;
                        cashoutBtn.style.display = 'block';
                        return;
                    }
                    medals -= continueCost;
                }
                playBetSound();
                
                currentCardValue = generateCurrentCardValue();
                
                currentCardContainerEl.classList.remove('flipped');
                nextCardContainerEl.classList.remove('flipped');
                setTimeout(() => {
                    currentCardEl.textContent = currentCardValue;
                    currentCardContainerEl.classList.add('flipped');
                    nextCardEl.textContent = '';
                    prepareForGuess();
                }, 600);
            } else if (actionBtn.textContent === 'ãƒœãƒ¼ãƒŠã‚¹é–‹å§‹ï¼') {
                isBonusGame = true;
                bonusPoints--;
                saveGameState();
                playBonusStartSound();
                
                medals += currentBet;
                currentBet = 0;

                betArea.style.display = 'none';
                
                messageEl.innerHTML = `<span class="text-violet-500 font-bold">å¥ªé‚„ãƒœãƒ¼ãƒŠã‚¹ ã‚¹ã‚¿ãƒ¼ãƒˆï¼</span>`;
                bonusGameStreak = 0;

                currentCardValue = generateCurrentCardValue();
                currentCardEl.textContent = currentCardValue;
                playCardFlipSound();
                currentCardContainerEl.classList.add('flipped');
                setTimeout(prepareForGuess, 400);

            } else { // "å‹è² ï¼"
                isBonusGame = false;
                currentCardValue = generateCurrentCardValue();
                currentCardEl.textContent = currentCardValue;
                playCardFlipSound();
                currentCardContainerEl.classList.add('flipped');
                setTimeout(prepareForGuess, 400);
            }
        });

        increaseBetBtn.addEventListener('click', () => {
            if (currentBet < 10 && (medals + currentBet) > currentBet) {
                medals--;
                currentBet++;
                playBetSound();
                updateUI();
            }
        });

        decreaseBetBtn.addEventListener('click', () => {
            if (currentBet > 1) {
                medals++;
                currentBet--;
                updateUI();
            }
        });

        highBtn.addEventListener('click', () => checkGuess('high'));
        lowBtn.addEventListener('click', () => checkGuess('low'));
        cashoutBtn.addEventListener('click', cashOut);
        resetBtn.addEventListener('click', startGame);
        buyShuffleBtn.addEventListener('click', () => buyItem('shuffle', 10));
        buyKnifeBtn.addEventListener('click', () => buyItem('knife', 30));

        // --- ã‚²ãƒ¼ãƒ åˆæœŸåŒ– ---
        window.onload = () => {
            loadGameState();
            startNewRound();
        };
    </script>
</body>
</html>
